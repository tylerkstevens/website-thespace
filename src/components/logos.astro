---
// @ts-ignore
import { Icon } from "astro-icon/components";
import { getCollection, type CollectionEntry } from "astro:content";

type SponsorEntry = CollectionEntry<"sponsors">;

const publishedSponsors: SponsorEntry[] = await getCollection("sponsors", ({ data }) => {
  return !data.draft && new Date(data.publishDate) <= new Date();
});

publishedSponsors.sort((a, b) => {
  const dateA = new Date(a.data.publishDate || "1970-01-01").getTime();
  const dateB = new Date(b.data.publishDate || "1970-01-01").getTime();
  return dateA - dateB;
});

const foundingSponsors = publishedSponsors.filter(sponsor =>
  new Date(sponsor.data.publishDate) <= new Date('2024-09-28')
);
const currentSponsors = publishedSponsors.filter(sponsor =>
  new Date(sponsor.data.publishDate) > new Date('2024-09-28')
);

const getFileFormat = (src: string) => {
  if (src.endsWith('.svg')) return 'svg';
  if (src.endsWith('.png')) return 'png';
  return 'webp';
};
---

<div class="mt-24 mb-0 custom-gradient py-12">
  <h2 class="text-center text-white px-12 mb-4">Made Possible by our Founding Supporters</h2>
  <div class="sponsors-grid mt-10 mb-2">
    {foundingSponsors.map(sponsor => {
      const format = getFileFormat(sponsor.data.avatar?.src || '');
      return (
        <a href={sponsor.data.url} target="_blank" rel="noopener noreferrer" class="block">
          {format === 'svg' ? (
            <div class="h-12 w-12 md:h-20 md:w-20 white-svg">
              <img
                src={sponsor.data.avatar?.src || '/default-event-image.webp'}
                alt={sponsor.data.avatar?.alt || sponsor.data.title}
                loading="lazy"
                class="object-contain h-full w-full"
                width="80"
                height="80"
              />
            </div>
          ) : (
            <img
              src={sponsor.data.avatar?.src || '/default-event-image.webp'}
              alt={sponsor.data.avatar?.alt || sponsor.data.title}
              loading="lazy"
              class="h-12 w-12 md:h-20 md:w-20 object-cover rounded-full"
              width="80"
              height="80"
            />
          )}
        </a>
      );
    })}
  </div>

  <h2 class="text-center text-white px-12 mt-12">Current Supporters</h2>
  <div class="sponsors-grid mt-10 mb-2">
    {currentSponsors.map(sponsor => {
      const format = getFileFormat(sponsor.data.avatar?.src || '');
      return (
        <a href={sponsor.data.url} target="_blank" rel="noopener noreferrer" class="block">
          {format === 'svg' ? (
            <div class="h-12 w-12 md:h-20 md:w-20 white-svg">
              <img
                src={sponsor.data.avatar?.src || '/default-event-image.webp'}
                alt={sponsor.data.avatar?.alt || sponsor.data.title}
                loading="lazy"
                class="object-contain h-full w-full"
                width="80"
                height="80"
              />
            </div>
          ) : (
            <img
              src={sponsor.data.avatar?.src || '/default-event-image.webp'}
              alt={sponsor.data.avatar?.alt || sponsor.data.title}
              loading="lazy"
              class="h-12 w-12 md:h-20 md:w-20 object-cover rounded-full"
              width="80"
              height="80"
            />
          )}
        </a>
      );
    })}
  </div>
</div>